<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<title>编辑页面</title>
	<link href="css/css-family=Open+Sans-300,400,600,700-PT+Sans+Narrow-Source+Sans+Pro-200,300,400,600,700,900&subset=all.css" tppabs="http://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700|PT+Sans+Narrow|Source+Sans+Pro:200,300,400,600,700,900&subset=all" rel="stylesheet" type="text/css">
	<link href="css/css-family=Source+Sans+Pro-200,300,400,600,700,900&subset=all.css" rel="stylesheet" type="text/css">
	<link href="assets/plugins/font-awesome/css/font-awesome.min.css" tppabs="http://demo.cssmoban.com/cssthemes4/tops_40_ShopUI/assets/plugins/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="assets/plugins/bootstrap/css/bootstrap.min.css" tppabs="http://demo.cssmoban.com/cssthemes4/tops_40_ShopUI/assets/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.bootcss.com/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.min.css" rel="stylesheet">
	
	<link rel="stylesheet" href="css/jquery.dad.css">
	<link href="css/home.css" rel="stylesheet">
<style>
	html{
		overflow-x: hidden;
	}
	.table{
		width: 90%;
	}
	.table>tbody>tr>td{
		border-top:0;
		vertical-align:inherit;
	}
	.table>tbody>tr>td>label{
		float: right;
	}
	span,label{
		margin: 0;
	}
	.set_up{
		margin:0 20px;
		background: #fff;
		z-index: 100;
		top: 0;
		padding: 5px 0;
	}
	.set_up td{
		padding: 0px 10px 0px 0px;
	}
	.editable-region{
		padding-top: 5px;
	}
	.region-container>*:not(:first-child){
		border: 1px solid #611610;
	}
	.dragging-region{
		text-align: right;
	}
	.editable-region .region-container{
		padding-top:20px ;
	}
	.editable-region .region-container img{
		border:1px solid #403336;
	}
	.editable-region .region-container  .edit-label-region *{
		min-height: 14px;
		min-width: 25px;
		border:0.1px solid;
	}
</style>
</head>
<body>
<div class="set_up">
	<table>
		<tr>
			<td>
				<select name="add_region" class="form-control add_region">
					<option value="data-v-1">添加区域1</option>
					<option value="data-v-2">添加区域2</option>
					<option value="data-v-3">添加区域3</option>
					<option value="data-v-4">添加区域4</option>
					<option value="data-v-5">添加区域5</option>
					<option value="data-v-6">添加区域6</option>
					<option value="data-v-7">添加区域7</option>
					<option value="data-v-8">添加区域8</option>
					<option value="" selected style="display:none" >请选择添加区域</option>
				  </select>
			</td>
			<td>
				<button type="button" class="btn btn-info preview_region">预览</button>
				<button type="button" class="btn btn-info submit_region">提交</button>
			</td>
			<td>上线时间:</td>
			<td>
				<div class='input-group date datetimepicker' id=''>
					<input name="start_time" type='text' class="form-control start_time"/>
					<span class="input-group-addon">
						<span class="glyphicon glyphicon-calendar"></span>
					</span>
				</div>
			</td>
			<td>
				
			</td>
		</tr>
	</table>
</div>
<div class="editable-region"></div>

<div class="contextMenu" id="btn_menu">
	<ul>
	  <li id="item_1">编辑</li>
	</ul>
</div>
<div class="contextMenu" id="image_menu">
	<ul>
	  <li id="item_1">上传图片</li>
	</ul>
</div>

<div class="modal fade modal_btn" tabindex="-1" role="dialog" id="modal_btn" >
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">编辑中</h4>
            </div>
            <div class="modal-body">
				<form class="modal_btn_from">
					<table class="table">
						<tr>
							<td><label class="control-label">按钮内容</label></td>
							<td colspan="4"><input name="info" type="text" class="info form-control" value=""></td>
						</tr>
						<tr>
							<td><label class="control-label">按钮位置</label></td>
							<td>
								<select name="position" class="form-control position">
									<option value="left">左边</option>
									<option value="center">中间</option>
									<option value="right">右边</option>
								</select>
							</td>
							<td><label class=" control-label">背景色</label></td>
							<td>
								<select name="background" class="form-control background">
									<option value="gl-cta-color-black">黑色</option>
									<option value="gl-cta-color-white">白色</option>
								</select>
							</td>
						</tr>
						<tr>
							<td><label class=" control-label">链接地址</label></td>
							<td colspan="4"><input name="link" type="text" class="link form-control" value=""></td>
						</tr>
					</table>	
				</form>			
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-info OK">确定</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div>

<div class="modal fade modal_label" tabindex="-1" role="dialog" id="modal_label" >
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">编辑中</h4>
            </div>
            <div class="modal-body">
				<form class="modal_label_from">
					<table class="table">
						<tr class="color_tr">
							<td><label class=" control-label">字体颜色</label></td>
							<td>
								<select name="color" class="form-control color">
									<option value="font-black">黑色</option>
									<option value="font-white">白色</option>
								</select>
							</td>
						</tr>
						<tr class="link_tr">
							<td><label class=" control-label">链接地址</label></td>
							<td colspan="4"><input name="link" type="text" class="link form-control" value=""></td>
						</tr>
					</table>	
				</form>			
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-info OK">确定</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div>

<div class="modal fade modal_imgae" tabindex="-1" role="dialog" id="modal_imgae" >
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">编辑中</h4>
            </div>
            <div class="modal-body">
				<form class="modal_imgae_from">
					<table class="table">
						<tr>
							<td><label class=" control-label">链接地址</label></td>
							<td colspan="4"><input name="link" type="text" class="link form-control" value=""></td>
						</tr>
						<tr>
							<td><button type="button" class="btn btn-info upload" style="float: right;">选择图片</button></td>
							<td colspan="4">
								<input class="upload-image" type="file" style="display: none;">
							</td>
						</tr>
					</table>	
				</form>			
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-info OK">确定</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div>

<script src="assets/plugins/jquery.min.js"></script>
<script src="assets/plugins/bootstrap/js/bootstrap.min.js" tppabs="http://demo.cssmoban.com/cssthemes4/tops_40_ShopUI/assets/plugins/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>      
<script src="https://cdn.bootcss.com/moment.js/2.24.0/moment-with-locales.js"></script>
<script src="https://cdn.bootcss.com/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js"></script>
<!-- 图片上传 -->
<script type="text/javascript" src="js/localResizeIMG.js"></script>
<script type="text/javascript" src="js/mobileBUGFix.mini.js"></script>
<!-- 右键 -->
<script src="js/jquery.contextmenu.r2.js"></script>
<!-- 拖拉拽 -->
<script src="js/html5sortable.js"></script>
<!-- 轮播图 -->
<script type="text/javascript" src="js/slider.js"></script> 
<!-- 页面区域 -->
<script type="text/javascript" src="js/loadPageRegion.js"></script> 
<script>
$(function(){ 
	/*	提交则吧草稿变为发布
		0 草稿
		1 已发布
		2 未编辑
		3 待删除
	*/
	var urlPrefix="http://localhost:8080/adminapi";
	loadPageRegion();

	function loadPageRegion(){
		$.ajax({
			url:urlPrefix+"/list_pageRegion",
			method:"get",
			success:function(result){	
				if(result.code==200){
					$.each(result.data,function(i,obj){
						$(".editable-region").regionContainerHTML(obj);//加载区域
						$(".region-container[data-prid="+obj.prId+"]")
							.find(".edit").attr("data-prid",obj.prId);
					});
					var str='<div class="dragging-region"><button type="button" class="btn btn-info delete_region">删除</button></div>';
					$(".region-container").prepend(str);		
					//设置区域拖拽
					sortable('.editable-region',{
						forcePlaceholderSize: true,
						placeholderClass: 'ph-class',
						hoverClass: 'bg-maroon yellow'
					});
					loadDeleteRegion();
					loadRightClickMenu();
				}	
			}
		})
	}

	//区域拖拽完成事件
	var sortstop=1;//防止重复监听
	sortable('.editable-region')[0].addEventListener('sortstop', function(e) {
		sortstop++;
		if(sortstop%2==0){
			var regionList=new Array();
			$.each($(".region-container"),function(i,obj){
				var $this=$(this);
				//获取所有区域信息
				regionList.push({"prId":$this.attr("data-prid"),
								"index":$this.index(".region-container"),
								"state":"0"})
			})
			console.info(regionList);
			$.ajax({
				url:urlPrefix+"/update_pageRegion",
				method:"post",
				data: JSON.stringify(regionList),
				dataType:"json",  
				contentType : 'application/json;charset=utf-8',  
				success:function(result){
					if(result.code==200){
						
					}
				}
			})
		}
	})	

	//日期和时间
	$('.datetimepicker').datetimepicker({
		format: 'YYYY-MM-DD hh:mm',
		showClear:true,
        locale: moment.locale('zh-cn')
	});
	
	//区域预览按钮事件
	var isPreview=true;
	$(".preview_region").off("click").on('click',function() {
		if(isPreview){
			isPreview=false;
			$(this).text("取消预览");
			$(".dragging-region").css({"display":"none"});
			$(".region-container").css({"padding-top":"0"})
			$(".region-container").find("div").css({"border":"0"});
			$(".region-container img").css({"border":"0px solid "});
			$(".region-container .edit-label-region *")
				.css({"border":"0px solid","min-height":""});
			$(".edit").removeClass("edit-label-region");
		}else{
			isPreview=true;
			$(this).text("预览");
			$(".dragging-region").css({"display":"block"});
			$(".region-container").css({"padding-top":"20px"})
			$(".region-container>*:not(:first-child)").css({"border":"1px solid #611610"});
			$(".region-container img").css({"border":"1px solid #403336"});
			$(".region-container .edit-label-region *")
				.css({"border":"0px solid","min-height":"14px"});
			$(".edit").addClass("edit-label-region");
		}

	})

	//提交按钮事件
	$(".submit_region").off("click").on('click',function() {
		var regionList=new Array();
		$.each($(".region-container"),function(i,obj){
			var $this=$(this);
			//获取所有区域信息
			regionList.push({"prId":$this.attr("data-prid"),
							"index":$this.index(".region-container"),
							"startTime":$(".start_time").val(),
							"state":"null"})
		})
		console.info(regionList);
		if(regionList[0].startTime==""){
			if(confirm("没有选择时间是否直接发布")){
				submitRegion(regionList);
			}
		}else{
			submitRegion(regionList);
		}
	})
	
	function submitRegion(regionList){
		$.ajax({
			url:urlPrefix+"/submit_pageRegion",
			method:"post",
			data: JSON.stringify(regionList),
			dataType:"json",  
			contentType : 'application/json;charset=utf-8',  
			success:function(result){
				if(result.code==200){
					alert(result.message);
				}
			}
		})
	}

	//添加新区域
	$(".add_region").off("change").on('change',function() {
		var $this=$(this);
		var region_sign="",editNumber=0,index;
		if($(".add_region option:selected").val()=="data-v-1"){
			editNumber=23;//设置可编辑数
			region_sign=$(".add_region option:selected").val();//区域标识
		}else if($(".add_region option:selected").val()=="data-v-2"){
			editNumber=24;
			region_sign=$(".add_region option:selected").val();
		}else if($(".add_region option:selected").val()=="data-v-3"){
			editNumber=14;
			region_sign=$(".add_region option:selected").val();
		}else if($(".add_region option:selected").val()=="data-v-4"){
			editNumber=20;
			region_sign=$(".add_region option:selected").val();
		}else if($(".add_region option:selected").val()=="data-v-5"){
			editNumber=47;
			region_sign=$(".add_region option:selected").val();
		}else if($(".add_region option:selected").val()=="data-v-6"){
			editNumber=22;
			region_sign=$(".add_region option:selected").val();
		}else if($(".add_region option:selected").val()=="data-v-7"){
			editNumber=5;
			region_sign=$(".add_region option:selected").val();
		}else if($(".add_region option:selected").val()=="data-v-8"){
			editNumber=8;
			region_sign=$(".add_region option:selected").val();
		}
		index=($(".editable-region").children().length);//获取顺序
		if(region_sign!=""){
			$.ajax({
				url:urlPrefix+"/add_pageRegion/"+region_sign+"/"+index+"/"+editNumber,
				method:"post",
				success:function(result){
					if(result.code==200){
						$this.val("");//清空单选值				
						//加载区域
						$(".editable-region").regionContainerHTML(result.data);
						$("html").scrollTop($("html")[0].scrollHeight);//滚动条置底
						$(".region-container[data-prid="+result.data.prId+"]")
							.find(".edit").attr("data-prid",result.data.prId);
						sortable('.editable-region');
						var str='<div class="dragging-region"><button type="button" class="btn btn-info delete_region">删除</button></div>';
						$(".region-container[data-prid="+result.data.prId+"]").prepend(str);		
						loadDeleteRegion();
						loadRightClickMenu();
					}
				}
			})
		}
	})	

	//删除区域事件
	function loadDeleteRegion(){
		$(".delete_region").off("click").on("click",function(){
			var $btn=$(this);
			//删除被删除区域的class并隐藏获取编号
			var prId=$btn.parent().parent().removeClass().css({"display":"none"}).attr("data-prid");
			var regionList=new Array();
			$.each($(".region-container"),function(i,obj){
				var $this=$(this);
				if(prId!=$this.attr("data-prid")){//更新区域的index
					regionList.push({"prId":$this.attr("data-prid"),
							"index":$this.index(".region-container"),
							"state":"0"})
				}
			})
			regionList.push({"prId":prId,//要删除的区域
							"index":"null",
							"state":"null"})
			console.info(regionList);
			$.ajax({
				url:urlPrefix+"/delete_pageRegionByState",
				method:"post",
				data: JSON.stringify(regionList), 
				dataType:"json",  
				contentType :'application/json;charset=utf-8',  
				success:function(result){
					if(result.code==200){
						$btn.parent().parent().remove();
						sortable('.editable-region');
					}
				}
			})
		})
	}

	//加载所有右键
	function loadRightClickMenu(){
		//轮播图
		$('.flexslider').flexslider({
			easing:"swing",
			animation: "slide", //转换方式 fade淡入淡出 slide滚动
			slideshowSpeed: 5000, //停留时间
		});
		$(".flexslider").find(".clone .img")
			.removeClass("edit edit-img-region").find("img").removeClass("edit")
		//按钮
		$('.edit-btn-region').contextMenu('btn_menu', {
			bindings:
				{
					'item_1': function(t) {
						$("#modal_btn").modal("show");
						$("#modal_btn  .info").val($(t).find(".edit").text());
						$("#modal_btn  .link").val($(t).parent().attr("href"));
						btnEditableBtnOK(t);
					}
				}
		})
		//标签
		$('.edit-label-region').contextMenu('btn_menu', {
			bindings:
				{
					'item_1': function(t) {
						$("#modal_label .table .info_tr").remove();
						$("#modal_label .table .link").val($(t).parent().attr("href"));
						//根据标题数量增加input框
						for(var i=1;i<=$(t).children().length;i++){
							$("#modal_label .table")
							.append ('<tr class="info_tr">' +
										'<td><label class="control-label">内容'+i+'</label></td>\n' +
										'<td><input name="info_'+i+'" type="text" class="info_'+i+' form-control" value="'+$(t).find(":eq("+(i-1)+")").html()+'"></td>' +
									'</tr>');
						}
						$("#modal_label").modal("show");
						labelEditableBtnOK(t);
					}
				}
		})
		//图片
		$('.edit-img-region').contextMenu('image_menu', {
			bindings:
				{
					'item_1': function(t) {
						$(".modal_imgae").modal("show");
						$(".modal_imgae .link").val($(t).attr("href"));
						var file=$(t).find("img").attr("src");
						$(".modal_imgae").find(".image").remove();
						$(".modal_imgae").find(".upload-image").before(
							'<img src="'+file+'" class="image" style="max-width: 400px;max-height: 300px;">');
						var prId="",index="",link="";
						$("#modal_imgae .OK").off("click").on("click",function(){
							prId=$(t).attr("data-prId");
							index=$(t).index(".region-container[data-prid="+prId+"] .edit");					
							link=$(".modal_imgae .link").val();
							updateEditRegionImage($(t),prId,index,link);
						})	
					}
				}
		})

	}

	//图片上传
	var imageBase64="";
	$('.upload-image').localResizeIMG({
		quality: 1,
		success: function (result) {
			imageBase64=result.base64;
			$(".modal_imgae .image").attr("src",imageBase64);
		}
	});

	//标签确认事件
	function labelEditableBtnOK(btn){
		$("#modal_label .OK").off("click").on("click",function(){
			var infoList=new Array();//保存临时编辑
			var $btn=$(btn);
			var prid=$btn.attr("data-prid");
			var $modal=$("#modal_label");
			infoList.push({"prId":prid,
						"index":$btn.index(".region-container[data-prid="+prid+"] .edit"),
						"info":$modal.find(".color").val(),"state":"0"});
			$btn.attr("class",$btn.attr("data-class")+" "+$modal.find(".color").val());
			infoList.push({"prId":prid,
							"index":$btn.parent().index(".region-container[data-prid="+prid+"] .edit"),
							"info":$modal.find(".link").val(),"state":"0"});
			$btn.parent().attr("href",$modal.find(".link").val());
			for(var i=0;i<$btn.children().length;i++){
				var info=$modal.find(".info_"+(i+1)).val();
				infoList.push({"prId":prid,
							"index":$btn.find(":eq("+i+")")
								.index(".region-container[data-prid="+prid+"] .edit"),
							"info":info,"state":"0"});
				$btn.find(":eq("+i+")").text(info);
			}
			updateEditRegionInfo(infoList);
			$("#modal_label").modal("hide");
			$(".modal_label_from")[0].reset();	
		});
	}

	//按钮确认事件
	function btnEditableBtnOK(btn){
		$("#modal_btn .OK").off("click").on("click",function(){
			var infoList=new Array();//保存临时编辑
			var $btn=$(btn);
			var prid=$btn.attr("data-prid");
			var $modal=$("#modal_btn");
			infoList.push({"prId":prid,
						"index":$btn.parent().index(".region-container[data-prid="+prid+"] .edit"),
						"info":$modal.find(".link").val(),"state":"0"});
			$btn.parent().attr("href",$modal.find(".link").val());
			var info=$modal.find(".info").val();
			infoList.push({"prId":prid,
						"index":$btn.find(".edit").index(".region-container[data-prid="+prid+"] .edit"),
						"info":info,"state":"0"});
			$btn.find(".edit").text(info);
			infoList.push({"prId":prid,
						"index":$btn.parent().parent().index(".region-container[data-prid="+prid+"] .edit"),
						"info":$modal.find(".position").val(),"state":"0"});
			$btn.parent().parent().attr("class",$btn.parent().parent()
				.attr("data-class")+" "+$modal.find(".position").val());
			infoList.push({"prId":prid,
						"index":$btn.index(".region-container[data-prid="+prid+"] .edit"),
						"info":$modal.find(".background").val(),"state":"0"});
			$btn.attr("class",$btn.attr("data-class")+" "+$modal.find(".background").val());
			updateEditRegionInfo(infoList);
			$("#modal_btn").modal("hide");
			$(".modal_btn_from")[0].reset();
		});
	}

	//修改区域内容
	function updateEditRegionInfo(infoList){
		console.info(infoList);
		$.ajax({
			url:urlPrefix+"/update_editInfo",
			method:"post",
			data: JSON.stringify(infoList),//将对象序列化成JSON字符串  
			dataType:"json",  
			contentType : 'application/json;charset=utf-8', //设置请求头信息  
			success:function(result){	
				$("#modal_imgae").modal("hide");
			}
		})
	}

	//修改区域图片
	function updateEditRegionImage($img,prId,index,link){
		if(imageBase64!=""){//判断是否上传了图片
			var file=dataBase64toFile(imageBase64,index);
			var data=new FormData();
			data.append("prId",prId);
			data.append("index",index);
			data.append("link",link);
			data.append("state","0");
			data.append("file",file);
			$.ajax({
				url:urlPrefix+"/update_editImage",
				method:"post",
				data: data,
				cache: false,
				processData: false,
				contentType: false,
				success:function(result){
					$img.attr("href",link);
					if($img.find("img").length>0){
						$img.find("img").attr("src",imageBase64).css({"border":"0"});	
					}
					$("#modal_imgae").modal("hide");
				}
			})
		}else{
			$img.attr("href",link);
			var infoList=new Array();//保存临时编辑
			infoList.push({"prId":prId,
						"index":index,"info":link,"state":"0"});
			updateEditRegionInfo(infoList);
		}
	}

	//选择上传图片按钮触发input
	$(".modal_imgae_from .upload").off("click").on("click",function(){
		$(".modal_imgae_from input").click();
	})

	//表单序列化成json
	$.fn.serializeJson=function(){
        var serializeObj={};
        var array=this.serializeArray();
        var str=this.serialize();
        $(array).each(function(){
          if(serializeObj[this.name]){
            if($.isArray(serializeObj[this.name])){
              serializeObj[this.name].push(this.value);
            }else{
              serializeObj[this.name]=[serializeObj[this.name],this.value];
            }
          }else{
            serializeObj[this.name]=this.value;
          }
        });
        return serializeObj;
      };

	//将base64转为file文件
	function dataBase64toFile(dataurl, filename) {
		var arr = dataurl.split(","),
			mime = arr[0].match(/:(.*?);/)[1],
			bstr = atob(arr[1]),
			n = bstr.length,
			u8arr = new Uint8Array(n);
		while (n--) {
			u8arr[n] = bstr.charCodeAt(n);
		}
		return new File([u8arr], filename, { type: mime });
	}
	
});
</script>
</body>
</html>